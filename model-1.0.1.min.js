(function(n,x){"object"===typeof module&&"object"===typeof module.exports?module.exports=n.document?x(n,!0):function(n){if(!n.document)throw Error("Model requires a window with a document");return x(n)}:x(n)})("undefined"!==typeof window?window:this,function(n,x){function B(a,b){if("string"==typeof a&&"string"==typeof b)return a.localeCompare(b);if("number"==typeof a&&"string"==typeof b)return-1;if("string"==typeof a&&"number"==typeof b)return 1;if("number"==typeof a&&"number"==typeof b){if(a>b)return 1;
if(a==b)return 0;if(a<b)return-1}return 0}function y(a,b,c,d){this.field=a;this.value=b;this.operator=c;this.boolean=d}function t(a){this.boolean=a;var b=[];this.getConditionArr=function(){return b};this.addCondition=function(a){a instanceof y||a instanceof t?b.push(a):d.isString(a)&&b.push(eval(a));return this};this.where=function(a,f,g,e){e=h.convert_boolean(e);g=h.convert_operator(g);if(d.isObject(a))for(var c in a)this.where(c,a[c],g,f);else if(d.isArray(a))for(var l in a)d.isDefined(a[l].field)&&
d.isDefined(a[l].value)&&this.where(a[l].field,a[l].value,a[l].operator,a[l]["boolean"]);else d.isString(a)&&0<String(a).length?b.push(new y(a,f,g,e)):d.isFunction(a)&&(f=new t(h.convert_boolean(f)),b.push(f),a.call(f));return this};this.queryString=function(a){var b="";d.each(this.getConditionArr(),function(c,e){var f=[];0<parseInt(c)&&(b+=" "+e["boolean"]+" ");e instanceof t?b+="("+e.queryString(a)+")":e instanceof y&&(c=e.field,d.isDefined(a[c])?(f.push(d.isNumber(a[c])?"{"+c+"}":"'{"+c+"}'"),
f.push(e.operator),f.push(d.isNumber(e.value)?e.value:"'"+("like"==e.operator?"%"+String(e.value)+"%":String(e.value))+"'")):f.push("false"));b+=f.join(" ")});return b};this.isMatch=function(a){var b=!1;d.each(this.getConditionArr(),function(c,e){var f=!1;if(e instanceof t)f=e.isMatch(a);else if(e instanceof y){var g=e.field,m=e.value;if(d.isDefined(a[g]))switch(e.operator){case "=":case "==":case "===":f=a[g]==m;break;case "<>":case "!=":case "!==":f=a[g]!=m;break;case "<":f=a[g]<m;break;case "<=":f=
a[g]<=m;break;case ">":f=a[g]>m;break;case ">=":f=a[g]>=m;break;case ">>":f=a[g]>>m;break;case "<<":f=a[g]<<m;break;case "like":m=String(m).replace(F,G);f=-1<String(a[g]).indexOf(m);break;default:f=!1}}else f=e;0==c&&(b=f);-1!=d.inArray(e["boolean"],C,0)?b=b||f:0<c&&(b=b&&f)});return b}}var u=[],z="== === < > <= >= <> != << >> like".split(" "),D=["&&","||","|"],H={and:"&&",or:"||"},E=["left","right","inner"],C=["||","|","or"],I={"'":"'","\\":"\\","\r":"r","\n":"n","\u2028":"u2028","\u2029":"u2029"},
F=/\\|'|\r|\n|\u2028|\u2029/g,G=function(a){return"\\"+I[a]},v={expressions:[],calculations:{},sorts:{},success:null},J=/^[\s\uFEFF\xA0]+|[\s\uFEFF\xA0]+$/g,p=function(a){return new p.fn.init(a)},w={get data(){return u},each:function(){d.each.apply(this,arguments)},sum:function(a,b){var c=0;this.each(b,function(b,g){d.isDefined(g[a])&&(c+=parseFloat(g[a]))});return c}},d={inArray:function(a,b,c){var d;if(b){if([].indexOf)return Array.prototype.indexOf.call(b,a,c);d=b.length;for(c=c?0>c?Math.max(0,
d+c):c:0;c<d;c++)if(c in b&&b[c]===a)return c}return-1},typeToString:function(a){return Object.prototype.toString.call(a)},trim:function(a){return null==a?"":(a+"").replace(J,"")},isWindow:function(a){return null!=a&&a==a.window},isEmptyObject:function(a){var b=0,c;for(c in a)if(b++,0<b)return!1;return!0},isPlainObject:function(a){var b;if(!a||"object"!==typeof a||a.nodeType||this.isWindow(a))return!1;var c=Object.prototype.hasOwnProperty;try{if(a.constructor&&!c.call(a,"constructor")&&!c.call(a.constructor.prototype,
"isPrototypeOf"))return!1}catch(f){return!1}for(b in a);return void 0===b||c.call(a,b)},isArray:function(a){return"[object Array]"==this.typeToString(a)},isDefined:function(a){return"undefined"!=typeof a},extend:function(){var a,b,c,f,g,e=arguments[0]||{},k=1,l=arguments.length,m=!1;"boolean"===typeof e&&(m=e,e=arguments[k]||{},k++);"object"===typeof e||d.isFunction(e)||(e={});for(k===l&&(e=this,k--);k<l;k++)if(null!=(g=arguments[k]))for(f in g)a=e[f],c=g[f],e!==c&&(m&&c&&(d.isPlainObject(c)||(b=
d.isArray(c)))?(b?(b=!1,a=a&&d.isArray(a)?a:[]):a=a&&d.isPlainObject(a)?a:{},e[f]=d.extend(m,a,c)):void 0!==c&&(e[f]=c));return e},each:function(a,b){var c,f=0;if(d.isArray(a))for(c=a.length;f<c&&!1!==b.call(a[f],f,a[f]);f++);else for(f in a)if(!1===b.call(a[f],f,a[f]))break;return a},filter:function(a,b){var c=d.isArray(a)?{}:[];d.each(a,function(a,g){d.isFunction()&&(c[a]=b.call(g,g,a))});return c}};d.each("Arguments Function String Number Date RegExp Error Object Boolean".split(" "),function(a,
b){d["is"+b]=function(a){return d.typeToString(a)==="[object "+b+"]"}});var h={extend:function(){d.extend.apply(this,arguments)}};h.extend({split_name:function(a,b){b=b?b:" ";a=d.trim(a.replace(/\s+/g," "));b=a.split(b);a=b[0];return[a,1<b.length?b[1]:a]},convert_join_type:function(a){return-1!=d.inArray(String(a).toLocaleLowerCase(),E,0)?a:E[2]},convert_reverse:function(a){return"desc"==String(a).toLocaleLowerCase()||1==a||1==a?1:0},convert_boolean:function(a){a=-1!=d.inArray(a,["and","or"],0)?H[a]:
a;return d.isString(a)&&-1<d.inArray(a,D,0)?a:D[0]},convert_operator:function(a){return d.isString(a)&&-1<d.inArray(a,z,0)?a:z[0]},convert_columns:function(a,b){var c=[];b=0<b.length?b:["*"];var f=0,g;for(g in b){var e=b[g];if(d.isString(e))if(e=d.trim(e),/^\s*\*\s*$/gi.test(e)){f++;for(var k in a)c.push({field:k,alias:""})}else e=e.replace(/^\s+(as)\s+$/i," as ").split(" as "),c.push({field:e[0],alias:e[1]?e[1]:""});else if(d.isObject(e))for(k in e)c.push({field:k,alias:d.isString(e[k])?e[k]:""})}return c},
groups:function(a,b,c){var f={},g=[];d.each(a,function(a,k){d.isDefined(k[b])&&(a=k[b],d.isDefined(f[a])||(g.push(a),f[a]=[],d.isFunction(c)&&c.call(k,a)),f[a].push(k))});return f},qv_filter:function(a,b,c,f){c=c?c:0;var g=this,e=[];if(0<b.length&&c<b.length-1){var k=b[c].field,l=[],m=g.groups(a,k,function(a){l.push(a)});if(0<l.length){var h=g.get_sort(f,k);if(!1!==h){var q=h.rudder,r=!1;d.isObject(q)?d.isDefined(q.reverse)&&(r=g.convert_reverse(q.reverse)):r=g.convert_reverse(q);l=d.isDefined(q.fx)?
l.sort(function(a,b){a=parseFloat(q.fx.call(w,m[a]));b=parseFloat(q.fx.call(w,m[b]));return(a<b?-1:1)*[1,-1][+!!r]}):l.sort(function(a,b){return B(a,b)*[1,-1][+!!r]})}d.each(l,function(a,l){var r=g.qv_filter(m[l],b,c+1,f);if(d.isDefined(v.calculations[k])){var h=v.calculations[k];a=d.isArray(r[0])?r[0]:r[0].data;var q={data:[]};d.each(a,function(a,f){q.data[a]=a<c?f:a==c?h.name:a>b.length-1?d.isFunction(h.fx)?h.fx.call(w,r,a):"":""});e.push(q)}d.each(r,function(a,b){e.push(b)})})}else return g.qv_filter(a,
b,c+1,f)}else{var A=[];d.each(b,function(b,c){A.push(a[0][c.field])});d.each(v.expressions,function(b,c){d.isDefined(c.fx)&&A.push(c.fx.apply(w,[a]))});e.push(A)}return e},join:function(a,b,c,f,g,e){var k=[],l=c[0],m=this.groups(c,f);d.each(a,function(a,c){a=c[b];d.isDefined(m[a])?d.each(m[a],function(a,b){d.isFunction(e)&&k.push(d.extend({},e.apply(d,[c,b,!0])))}):-1!=d.inArray(g,["left","right"],0)&&d.isFunction(e)&&k.push(d.extend({},e.apply(d,[c,l,!1])))});return k},order_by:function(a,b,c,f){c=
c?c:0;var g=this,e=[];if(0<b.length&&c<b.length){var k=b[c],l=[],m=g.groups(a,k.field,function(a){l.push(a)});if(0<l.length){var h=k.rudder,q=!1;d.isObject(h)?d.isDefined(h.reverse)&&(q=g.convert_reverse(h.reverse)):q=g.convert_reverse(h);l=d.isDefined(h.fx)?l.sort(function(a,b){a=parseFloat(h.fx.call(w,m[a]));b=parseFloat(h.fx.call(w,m[b]));return(a<b?-1:1)*[1,-1][+!!q]}):l.sort(function(a,b){return B(a,b)*[1,-1][+!!q]});d.each(l,function(a,h){a=m[h];c<b.length-1?(a=g.order_by(a,b,c+1,f),d.each(a,
function(a,b){e.push(b)})):d.each(a,function(a,b){g.is_match(b,f)&&e.push(b)})})}else return g.order_by(a,b,c+1,f)}else d.each(a,function(a,b){g.is_match(b,f)&&e.push(b)});return e},get_sort:function(a,b){var c=!1;d.each(a,function(a,d){if(d.field==b)return c=d,!1});return c},is_match:function(a,b){var c=!0,f=0;d.each(b,function(b,e){e instanceof t&&(c=0==f?e.isMatch(a):-1!=d.inArray(e["boolean"],C,0)?c||e.isMatch(a):c&&e.isMatch(a),f++)});return c},get_sql:function(a,b){var c=[];d.each(b,function(b,
d){d instanceof t&&(0<c.length&&c.push(d.boolean),c.push(d.queryString(a)))});return c.join(" ")}});p.fn=p.prototype={model:"1.0.1",constructor:p,extend:function(){return d.extend.apply(this,arguments)},init:function(a){this.clear();this.table(a);(new Date).getTime();return this}};p.fn.extend({clear:function(){this.bindings={where:[],wheres:[],fields:[],limit:[],order_by:[]};return this},table:function(a,b){u=a;b=d.trim(b);d.isString(b)&&""!=b&&h.split_name(b," ");return this},view:function(a){var b=
h.convert_columns(u[0],this.bindings.fields),c=[],f=[];d.each(b,function(a,b){c.push(""!=b.alias?b.alias:b.field)});d.each(v.expressions,function(a,b){c.push(b.name)});v=d.extend({},v,a);f=h.qv_filter(u,b,0,this.bindings.order_by);d.isFunction(v.success)&&v.success.apply(this,[f,c]);return this},fields:function(a){var b=this;d.isString(a)||d.isObject(a)?b.bindings.fields.push(a):d.isArray(a)&&d.each(a,function(a,d){b.fields(d)});return this},join:function(a,b,c,d){d=h.convert_join_type(d);c=h.split_name(c,
".");var f=c[0];c=c[1];var e=function(a,b,c){var d={},e;for(e in a)d[e]=a[e];for(var g in b)d[f+"."+g]=1==c?b[g]:null;return d};u="right"==d?h.join(b,c,u,a,d,e):h.join(u,a,b,c,d,e);return this},order_by:function(a,b){var c=this;d.isArray(a)?d.each(a,function(a,d){c.order_by(d,b)}):d.isObject(a)?d.each(a,function(a,b){c.order_by(a,b)}):d.isString(a)&&c.bindings.order_by.push({field:a,rudder:b});return this},where:function(a,b,c,f){f=h.convert_boolean(f);c=h.convert_operator(c);if(d.isObject(a))for(var g in a)this.where(g,
a[g],c,h.convert_boolean(b));else if(d.isArray(a))for(var e in a)d.isDefined(a[e].field)&&d.isDefined(a[e].value)&&this.where(a[e].field,a[e].value,a[e].operator,a[e]["boolean"]);else d.isString(a)&&0<String(a).length?this.bindings.where.push((new t(f)).where(a,b,c,f)):d.isFunction(a)&&(c=new t(h.convert_boolean(b)),b=new t(h.convert_boolean(b)),c.addCondition(b),this.bindings.where.push(c),a.call(b));return this},where_in:function(a,b,c){d.isString(a)&&this.where(function(){if(d.isArray(b))for(var c in b)this.where(a,
b[c],z[0],"||")},c);return this},where_not_in:function(a,b,c){d.isString(a)&&this.where(function(){if(d.isArray(b))for(var c in b)this.where(a,b[c],"!=")},c);return this},where_between:function(a,b){d.isArray(b)&&1<b.length&&this.where(function(){this.where(a,Math.min(b[0],b[1]),">");this.where(a,Math.max(b[0],b[1]),"<")});return this},where_like:function(a,b,c){this.where(a,b,"like",c);return this},limit:function(a,b){1==arguments.length?this.bindings.limit=[0,Math.max(0,a)]:1<arguments.length&&
(this.bindings.limit=[Math.max(0,a),Math.max(0,a+b)]);return this},get:function(){var a=h.order_by(u,this.bindings.order_by,0,this.bindings.where);0<this.bindings.limit.length&&(a=a.slice(this.bindings.limit[0],this.bindings.limit[1]));console.log(a);return a},find:function(a){return this.where(a).get()[0]},fetch:function(a){var b=this.get();return d.isFunction(a)?(d.each(b,a),this):b},select:function(a,b){return this.fields(a).where(b).get()},count:function(){return this.get().length},toSql:function(a){var b=
h.get_sql(u[0],this.bindings.where);return 1==a?(console.log(b),this):b}});p.fn.init.prototype=p.fn;p.fn.size=function(){return this.length};"function"===typeof define&&define.amd&&define("model",[],function(){return p});var K=n.Model,L=n.M;p.noConflict=function(a){n.M===p&&(n.M=L);a&&n.Model===p&&(n.Model=K);return p};x||(n.Model=n.M=p);return p});
