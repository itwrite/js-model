(function(m,x){"object"===typeof module&&"object"===typeof module.exports?module.exports=m.document?x(m,!0):function(m){if(!m.document)throw Error("Model requires a window with a document");return x(m)}:x(m)})("undefined"!==typeof window?window:this,function(m,x){function B(a,b){if("string"==typeof a&&"string"==typeof b)return a.localeCompare(b);if("number"==typeof a&&"string"==typeof b)return-1;if("string"==typeof a&&"number"==typeof b)return 1;if("number"==typeof a&&"number"==typeof b){if(a>b)return 1;
if(a==b)return 0;if(a<b)return-1}return 0}function y(a,b,c,d){this.field=a;this.value=b;this.operator=c;this.boolean=d}function u(a){this.boolean=a;var b=[];this.getConditionArr=function(){return b};this.addCondition=function(a){a instanceof y||a instanceof u?b.push(a):d.isString(a)&&b.push(eval(a));return this};this.where=function(a,f,g,e){e=k.convert_boolean(e);g=k.convert_operator(g);if(d.isObject(a))for(var c in a)this.where(c,a[c],g,f);else if(d.isArray(a))for(var l in a)d.isDefined(a[l].field)&&
d.isDefined(a[l].value)&&this.where(a[l].field,a[l].value,a[l].operator,a[l]["boolean"]);else d.isString(a)&&0<String(a).length?b.push(new y(a,f,g,e)):d.isFunction(a)&&(f=new u(k.convert_boolean(f)),b.push(f),a.call(f));return this};this.queryString=function(a){var b="";d.each(this.getConditionArr(),function(c,e){var f=[];0<parseInt(c)&&(b+=" "+e["boolean"]+" ");e instanceof u?b+="("+e.queryString(a)+")":e instanceof y&&(c=e.field,d.isDefined(a[c])?(f.push(d.isNumber(a[c])?"{"+c+"}":"'{"+c+"}'"),
f.push(e.operator),f.push(d.isNumber(e.value)?e.value:"'"+("like"==e.operator?"%"+String(e.value)+"%":String(e.value))+"'")):f.push("false"));b+=f.join(" ")});return b};this.isLike=function(a,b){var c=!1;d.each(b,function(b,d){if(""!==d&&-1<String(a).indexOf(d))return c=!0,!1});return c};this.isMatch=function(a){var b=this,c=!1;d.each(this.getConditionArr(),function(e,f){var g=!1;if(f instanceof u)g=f.isMatch(a);else if(f instanceof y){var h=f.field,n=f.value;if(d.isDefined(a[h]))switch(f.operator){case "=":case "==":case "===":g=
a[h]==n;break;case "<>":case "!=":case "!==":g=a[h]!=n;break;case "<":g=a[h]<n;break;case "<=":g=a[h]<=n;break;case ">":g=a[h]>n;break;case ">=":g=a[h]>=n;break;case ">>":g=a[h]>>n;break;case "<<":g=a[h]<<n;break;case "like":n=String(n).replace(H,I);g=n.split("%");g=b.isLike(a[h],g);break;default:g=!1}}else g=f;0==e&&(c=g);-1!=d.inArray(f["boolean"],C,0)?c=c||g:0<e&&(c=c&&g)});return c}}var D=!1,E=null,t=[],z="== === < > <= >= <> != << >> like".split(" "),F=["&&","||","|"],J={and:"&&",or:"||"},G=
["left","right","inner"],C=["||","|","or"],K={"'":"'","\\":"\\","\r":"r","\n":"n","\u2028":"u2028","\u2029":"u2029"},H=/\\|'|\r|\n|\u2028|\u2029/g,I=function(a){return"\\"+K[a]},v={expressions:[],calculations:{},sorts:{},success:null},L=/^[\s\uFEFF\xA0]+|[\s\uFEFF\xA0]+$/g,q=function(a){return new q.fn.init(a)},w={get data(){return t},each:function(){d.each.apply(this,arguments)},sum:function(a,b){var c=0;this.each(b,function(b,g){d.isDefined(g[a])&&(c+=parseFloat(g[a]))});return c}},M=function(){if(1==
D){var a=["echo["+((new Date).getTime()-E)+"]:"],b;for(b in arguments)a.push(arguments[b]);console.log.apply(this,a)}},d={inArray:function(a,b,c){var d;if(b){if([].indexOf)return Array.prototype.indexOf.call(b,a,c);d=b.length;for(c=c?0>c?Math.max(0,d+c):c:0;c<d;c++)if(c in b&&b[c]===a)return c}return-1},typeToString:function(a){return Object.prototype.toString.call(a)},trim:function(a){return null==a?"":(a+"").replace(L,"")},isWindow:function(a){return null!=a&&a==a.window},isEmptyObject:function(a){var b=
0,c;for(c in a)if(b++,0<b)return!1;return!0},isPlainObject:function(a){var b;if(!a||"object"!==typeof a||a.nodeType||this.isWindow(a))return!1;var c=Object.prototype.hasOwnProperty;try{if(a.constructor&&!c.call(a,"constructor")&&!c.call(a.constructor.prototype,"isPrototypeOf"))return!1}catch(f){return!1}for(b in a);return void 0===b||c.call(a,b)},isArray:function(a){return"[object Array]"==this.typeToString(a)},isDefined:function(a){return"undefined"!=typeof a},extend:function(){var a,b,c,f,g,e=arguments[0]||
{},h=1,l=arguments.length,r=!1;"boolean"===typeof e&&(r=e,e=arguments[h]||{},h++);"object"===typeof e||d.isFunction(e)||(e={});h===l&&(e=this,h--);for(;h<l;h++)if(null!=(g=arguments[h]))for(f in g)a=e[f],c=g[f],e!==c&&(r&&c&&(d.isPlainObject(c)||(b=d.isArray(c)))?(b?(b=!1,a=a&&d.isArray(a)?a:[]):a=a&&d.isPlainObject(a)?a:{},e[f]=d.extend(r,a,c)):void 0!==c&&(e[f]=c));return e},each:function(a,b){var c,f=0;if(d.isArray(a))for(c=a.length;f<c&&!1!==b.call(a[f],f,a[f]);f++);else for(f in a)if(!1===b.call(a[f],
f,a[f]))break;return a},filter:function(a,b){var c=d.isArray(a)?{}:[];d.each(a,function(a,g){d.isFunction()&&(c[a]=b.call(g,g,a))});return c}};d.each("Arguments Function String Number Date RegExp Error Object Boolean".split(" "),function(a,b){d["is"+b]=function(a){return d.typeToString(a)==="[object "+b+"]"}});var k={extend:function(){d.extend.apply(this,arguments)}};k.extend({split_name:function(a,b){b=b?b:" ";a=d.trim(a.replace(/\s+/g," "));b=a.split(b);a=b[0];return[a,1<b.length?b[1]:a]},convert_join_type:function(a){return-1!=
d.inArray(String(a).toLocaleLowerCase(),G,0)?a:G[2]},convert_reverse:function(a){return"desc"==String(a).toLocaleLowerCase()||1==a||1==a?1:0},convert_boolean:function(a){a=-1!=d.inArray(a,["and","or"],0)?J[a]:a;return d.isString(a)&&-1<d.inArray(a,F,0)?a:F[0]},convert_operator:function(a){return d.isString(a)&&-1<d.inArray(a,z,0)?a:z[0]},convert_columns:function(a,b){var c=[];b=0<b.length?b:["*"];var f=0,g;for(g in b){var e=b[g];if(d.isString(e))if(e=d.trim(e),/^\s*\*\s*$/gi.test(e)){f++;for(var h in a)c.push({field:h,
alias:""})}else e=e.replace(/^\s+(as)\s+$/i," as ").split(" as "),c.push({field:e[0],alias:e[1]?e[1]:""});else if(d.isObject(e))for(h in e)c.push({field:h,alias:d.isString(e[h])?e[h]:""})}return c},groups:function(a,b,c){var f={},g=[];d.each(a,function(a,h){d.isDefined(h[b])&&(a=h[b],d.isDefined(f[a])||(g.push(a),f[a]=[],d.isFunction(c)&&c.call(h,a)),f[a].push(h))});return f},qv_filter:function(a,b,c,f){c=c?c:0;var g=this,e=[];if(0<b.length&&c<b.length-1){var h=b[c].field,l=[],r=g.groups(a,h,function(a){l.push(a)});
if(0<l.length){var n=g.get_sort(f,h);if(!1!==n){var p=n.rudder,k=!1;d.isObject(p)?d.isDefined(p.reverse)&&(k=g.convert_reverse(p.reverse)):k=g.convert_reverse(p);l=d.isDefined(p.fx)?l.sort(function(a,b){a=parseFloat(p.fx.call(w,r[a]));b=parseFloat(p.fx.call(w,r[b]));return(a<b?-1:1)*[1,-1][+!!k]}):l.sort(function(a,b){return B(a,b)*[1,-1][+!!k]})}d.each(l,function(a,n){var l=g.qv_filter(r[n],b,c+1,f);if(d.isDefined(v.calculations[h])){var k=v.calculations[h];a=d.isArray(l[0])?l[0]:l[0].data;var p=
{data:[]};d.each(a,function(a,e){p.data[a]=a<c?e:a==c?k.name:a>b.length-1?d.isFunction(k.fx)?k.fx.call(w,l,a):"":""});e.push(p)}d.each(l,function(a,b){e.push(b)})})}else return g.qv_filter(a,b,c+1,f)}else{var A=[];d.each(b,function(b,c){A.push(a[0][c.field])});d.each(v.expressions,function(b,c){d.isDefined(c.fx)&&A.push(c.fx.apply(w,[a]))});e.push(A)}return e},join:function(a,b,c,f,g,e){var h=[],l=c[0],k=this.groups(c,f);d.each(a,function(a,c){a=c[b];d.isDefined(k[a])?d.each(k[a],function(a,b){d.isFunction(e)&&
h.push(d.extend({},e.apply(d,[c,b,!0])))}):-1!=d.inArray(g,["left","right"],0)&&d.isFunction(e)&&h.push(d.extend({},e.apply(d,[c,l,!1])))});return h},order_by:function(a,b,c,f,g){c=c?c:0;var e=this,h=[];if(0<b.length&&c<b.length){var k=b[c],r=[],n=e.groups(a,k.field,function(a){r.push(a)});if(0<r.length){var p=k.rudder,m=!1;d.isObject(p)?d.isDefined(p.reverse)&&(m=e.convert_reverse(p.reverse)):m=e.convert_reverse(p);r=d.isDefined(p.fx)?r.sort(function(a,b){a=parseFloat(p.fx.call(w,n[a]));b=parseFloat(p.fx.call(w,
n[b]));return(a<b?-1:1)*[1,-1][+!!m]}):r.sort(function(a,b){return B(a,b)*[1,-1][+!!m]});d.each(r,function(a,k){a=e.order_by(n[k],b,c+1,f,g);d.each(a,function(a,b){h.push(b)})})}else return e.order_by(a,b,c+1,f,g)}else d.each(a,function(a,b){if(e.is_match(b,f)){var c={};d.each(g,function(a,e){a=e.field;d.isDefined(b[a])&&(c[""==e.alias?e.field:e.alias]=b[a])});h.push(c)}});return h},get_sort:function(a,b){var c=!1;d.each(a,function(a,d){if(d.field==b)return c=d,!1});return c},is_match:function(a,
b){var c=!0,f=0;d.each(b,function(b,e){e instanceof u&&(c=0==f?e.isMatch(a):-1!=d.inArray(e["boolean"],C,0)?c||e.isMatch(a):c&&e.isMatch(a),f++)});return c},get_sql:function(a,b){var c=[];d.each(b,function(b,d){d instanceof u&&(0<c.length&&c.push(d.boolean),c.push(d.queryString(a)))});return c.join(" ")}});q.fn=q.prototype={model:"1.0.1",constructor:q,extend:function(){return d.extend.apply(this,arguments)},init:function(a){this.clear();this.table(a);E=(new Date).getTime();return this},debug:function(a){D=
a;return this}};q.fn.extend({clear:function(){this.bindings={where:[],wheres:[],fields:[],limit:[],order_by:[]};return this},table:function(a,b){t=a;b=d.trim(b);d.isString(b)&&""!=b&&k.split_name(b," ");return this},view:function(a){var b=k.convert_columns(t[0],this.bindings.fields),c=[],f=[];d.each(b,function(a,b){c.push(""!=b.alias?b.alias:b.field)});d.each(v.expressions,function(a,b){c.push(b.name)});v=d.extend({},v,a);f=k.qv_filter(t,b,0,this.bindings.order_by);d.isFunction(v.success)&&v.success.apply(this,
[f,c]);return this},fields:function(a){var b=this;d.isString(a)||d.isObject(a)?b.bindings.fields.push(a):d.isArray(a)&&d.each(a,function(a,d){b.fields(d)});return this},join:function(a,b,c,d){d=k.convert_join_type(d);c=k.split_name(c,".");var f=c[0];c=c[1];var e=function(a,b,c){var d={},e;for(e in a)d[e]=a[e];for(var g in b)d[f+"."+g]=1==c?b[g]:null;return d};t="right"==d?k.join(b,c,t,a,d,e):k.join(t,a,b,c,d,e);M("__data.length",t.length);return this},order_by:function(a,b){var c=this;d.isArray(a)?
d.each(a,function(a,d){c.order_by(d,b)}):d.isObject(a)?d.each(a,function(a,b){c.order_by(a,b)}):d.isString(a)&&c.bindings.order_by.push({field:a,rudder:b});return this},where:function(a,b,c,f){f=k.convert_boolean(f);c=k.convert_operator(c);if(d.isObject(a))for(var g in a)this.where(g,a[g],c,k.convert_boolean(b));else if(d.isArray(a))for(var e in a)d.isDefined(a[e].field)&&d.isDefined(a[e].value)&&this.where(a[e].field,a[e].value,a[e].operator,a[e]["boolean"]);else d.isString(a)&&0<String(a).length?
this.bindings.where.push((new u(f)).where(a,b,c,f)):d.isFunction(a)&&(c=new u(k.convert_boolean(b)),b=new u(k.convert_boolean(b)),c.addCondition(b),this.bindings.where.push(c),a.call(b));return this},where_in:function(a,b,c){d.isString(a)&&this.where(function(){if(d.isArray(b))for(var c in b)this.where(a,b[c],z[0],"||")},c);return this},where_not_in:function(a,b,c){d.isString(a)&&this.where(function(){if(d.isArray(b))for(var c in b)this.where(a,b[c],"!=")},c);return this},where_between:function(a,
b){d.isArray(b)&&1<b.length&&this.where(function(){this.where(a,Math.min(b[0],b[1]),">");this.where(a,Math.max(b[0],b[1]),"<")});return this},where_like:function(a,b,c){this.where(a,b,"like",c);return this},limit:function(a,b){1==arguments.length?this.bindings.limit=[0,Math.max(0,a)]:1<arguments.length&&(this.bindings.limit=[Math.max(0,a),Math.max(0,a+b)]);return this},get:function(){var a=k.order_by(t,this.bindings.order_by,0,this.bindings.where);0<this.bindings.limit.length&&(a=a.slice(this.bindings.limit[0],
this.bindings.limit[1]));console.log(a);return a},find:function(a){return this.where(a).get()[0]},fetch:function(a){var b=this.get();return d.isFunction(a)?(d.each(b,a),this):b},select:function(a,b){return this.fields(a).where(b).get()},count:function(){return this.get().length},toSql:function(a){var b=k.get_sql(t[0],this.bindings.where);return 1==a?(console.log(b),this):b}});q.fn.init.prototype=q.fn;q.fn.size=function(){return this.length};"function"===typeof define&&define.amd&&define("model",[],
function(){return q});var N=m.Model,O=m.M;q.noConflict=function(a){m.M===q&&(m.M=O);a&&m.Model===q&&(m.Model=N);return q};x||(m.Model=m.M=q);return q});
