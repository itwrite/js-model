(function(h,q){"object"===typeof module&&"object"===typeof module.exports?module.exports=h.document?q(h,!0):function(h){if(!h.document)throw Error("Model requires a window with a document");return q(h)}:q(h)})("undefined"!==typeof window?window:this,function(h,q){function C(a,b){if("string"==typeof a&&"string"==typeof b)return a.localeCompare(b);if("number"==typeof a&&"string"==typeof b)return-1;if("string"==typeof a&&"number"==typeof b)return 1;if("number"==typeof a&&"number"==typeof b){if(a>b)return 1;
if(a==b)return 0;if(a<b)return-1}return 0}function u(a,b,c,f){var d,g;Object.defineProperty(this,"boolean",{get:function(){return g},set:function(a){g=m.convert_boolean(a)}});Object.defineProperty(this,"operator",{get:function(){return d},set:function(a){d=m.convert_operator(a)}});this.field=a;this.value=c;this.boolean=f;this.operator=b}function r(a){var b,c=[];Object.defineProperty(this,"boolean",{get:function(){return b},set:function(a){b=m.convert_boolean(a)}});this.boolean=a;this.getConditionArr=
function(){return c};this.where=function(a,b,g,l){if(d.isObject(a))for(var f in a)this.where(f,"==",a[f],b);else if(d.isArray(a))for(var e in a)d.isDefined(a[e].field)&&d.isDefined(a[e].value)&&this.where(a[e].field,a[e].operator,a[e].value,a[e]["boolean"]);else d.isString(a)&&0<String(a).length?c.push(new u(a,b,g,l)):d.isFunction(a)&&(b=new r(b),c.push(b),a.call(b));return this};this.queryString=function(a){var b="";d.each(this.getConditionArr(),function(c,f){var e=[];0<parseInt(c)&&(b+=-1!=d.inArray(f["boolean"],
v,0)?" OR ":" AND ");f instanceof r?b+="( "+f.queryString(a)+" )":f instanceof u&&(c=f.field,d.isDefined(a[c])?(e.push(d.isNumber(a[c])?"{"+c+"}":"'{"+c+"}'"),e.push(f.operator),e.push(d.isNumber(f.value)?f.value:"'"+("like"==f.operator?"%"+String(f.value)+"%":String(f.value))+"'")):e.push("false"));b+=e.join(" ")});return b};this.isMatch=function(a){var b=!0;d.each(this.getConditionArr(),function(c,f){var e=!1;if(f instanceof r)e=f.isMatch(a);else if(f instanceof u){var g=f.field,n=f.value;if(d.isDefined(a[g]))switch(f.operator){case "=":case "==":e=
a[g]==n;break;case "===":e=a[g]===n;break;case "!=":e=a[g]!=n;break;case "<>":case "!==":e=a[g]!==n;break;case "<":case "<<":e=a[g]<n;break;case "<=":e=a[g]<=n;break;case ">":case ">>":e=a[g]>n;break;case ">=":e=a[g]>=n;break;case "like":e=function(a,b){var c=!1;d.each(b,function(b,d){if(""!==d&&-1<String(a).indexOf(d))return c=!0,!1});return c}(a[g],String(n).replace(D,E).split("%"));break;default:e=!1}}else e=f;0==c?b=e:-1!=d.inArray(f["boolean"],v,0)?b=b||e:0<c&&(b=b&&e)});return b}}var x=!1,y=
null,p=[],t="== === < > <= >= <> != << >> like".split(" "),z=["&&","||","|"],F={and:"&&",or:"||"},A=["left","right","inner"],v=["||","|","or"],G=/^[\s\uFEFF\xA0]+|[\s\uFEFF\xA0]+$/g,D=/\\|'|\r|\n|\u2028|\u2029/g,k=function(a){return new k.fn.init(a)},H={"'":"'","\\":"\\","\r":"r","\n":"n","\u2028":"u2028","\u2029":"u2029"},E=function(a){return"\\"+H[a]},B={get data(){return p},each:function(){d.each.apply(this,arguments)},sum:function(a,b){var c=0;this.each(b,function(b,e){d.isDefined(e[a])&&(c+=
parseFloat(e[a]))});return c}},w=function(){if(1==x){var a=["echo["+((new Date).getTime()-y)/1E3+"s]:"],b;for(b in arguments)a.push(arguments[b]);console.log.apply(this,a)}},d={inArray:function(a,b,c){var d;if(b){if([].indexOf)return Array.prototype.indexOf.call(b,a,c);d=b.length;for(c=c?0>c?Math.max(0,d+c):c:0;c<d;c++)if(c in b&&b[c]===a)return c}return-1},typeToString:function(a){return Object.prototype.toString.call(a)},trim:function(a){return null==a?"":(a+"").replace(G,"")},isWindow:function(a){return null!=
a&&a==a.window},isEmptyObject:function(a){var b=0,c;for(c in a)if(b++,0<b)return!1;return!0},isPlainObject:function(a){var b;if(!a||"object"!==typeof a||a.nodeType||this.isWindow(a))return!1;var c=Object.prototype.hasOwnProperty;try{if(a.constructor&&!c.call(a,"constructor")&&!c.call(a.constructor.prototype,"isPrototypeOf"))return!1}catch(f){return!1}for(b in a);return void 0===b||c.call(a,b)},isArray:function(a){return"[object Array]"==this.typeToString(a)},isDefined:function(a){return"undefined"!=
typeof a},extend:function(){var a,b,c,f,e,g=arguments[0]||{},l=1,h=arguments.length,k=!1;"boolean"===typeof g&&(k=g,g=arguments[l]||{},l++);"object"===typeof g||d.isFunction(g)||(g={});l===h&&(g=this,l--);for(;l<h;l++)if(null!=(e=arguments[l]))for(f in e)a=g[f],c=e[f],g!==c&&(k&&c&&(d.isPlainObject(c)||(b=d.isArray(c)))?(b?(b=!1,a=a&&d.isArray(a)?a:[]):a=a&&d.isPlainObject(a)?a:{},g[f]=d.extend(k,a,c)):void 0!==c&&(g[f]=c));return g},each:function(a,b){var c,f=0;if(d.isArray(a))for(c=a.length;f<c&&
!1!==b.call(a[f],f,a[f]);f++);else for(f in a)if(!1===b.call(a[f],f,a[f]))break;return a},filter:function(a,b){var c=d.isArray(a)?{}:[];d.each(a,function(a,e){d.isFunction()&&(c[a]=b.call(e,e,a))});return c}};d.each("Arguments Function String Number Date RegExp Error Object Boolean".split(" "),function(a,b){d["is"+b]=function(a){return d.typeToString(a)==="[object "+b+"]"}});var m={extend:function(){d.extend.apply(this,arguments)}};m.extend({split_name:function(a,b){b=b?b:" ";a=d.trim(a.replace(/\s+/g,
" "));b=a.split(b);a=b[0];return[a,1<b.length?b[1]:a]},convert_join_type:function(a){return-1!=d.inArray(String(a).toLocaleLowerCase(),A,0)?a:A[2]},convert_reverse:function(a){return"desc"==String(a).toLocaleLowerCase()||1==a||1==a?1:0},convert_boolean:function(a){a=-1!=d.inArray(a,["and","or"],0)?F[a]:a;return d.isString(a)&&-1<d.inArray(a,z,0)?a:z[0]},convert_operator:function(a){return d.isString(a)&&-1<d.inArray(a,t,0)?a:t[0]},convert_columns:function(a,b){var c=[];b=0<b.length?b:["*"];var f=
0,e;for(e in b){var g=b[e];if(d.isString(g))if(g=d.trim(g),/^\s*\*\s*$/gi.test(g)){f++;for(var l in a)c.push({field:l,alias:""})}else g=g.replace(/^\s+(as)\s+$/i," as ").split(" as "),c.push({field:g[0],alias:g[1]?g[1]:""});else if(d.isObject(g))for(l in g)c.push({field:l,alias:d.isString(g[l])?g[l]:""})}return c},join:function(a,b,c,f,e,g){var l=[],k=c[0],h=this.groups(c,f);d.each(a,function(a,c){a=c[b];d.isDefined(h[a])?d.each(h[a],function(a,b){d.isFunction(g)&&l.push(d.extend({},g.apply(d,[c,
b,!0])))}):-1!=d.inArray(e,["left","right"],0)&&d.isFunction(g)&&l.push(d.extend({},g.apply(d,[c,k,!1])))});return l},groups:function(a,b){var c={};d.each(a,function(a,e){a=e[b];d.isDefined(a)&&(d.isDefined(c[a])||(c[a]=[]),c[a].push(e))});return c},order_by:function(a,b,c,f,e){c=0<c?c:0;var g=this,l=[];if(0<b.length&&c<b.length){var h=b[c],k=h.field,n={},m=[];d.isFunction(e)?d.each(a,function(a,b){var c=b[k];d.isDefined(c)&&!0===e.call(b,b,a)&&(d.isDefined(n[c])||(m.push(c),n[c]=[]),n[c].push(b))}):
d.each(a,function(a,b){a=b[k];d.isDefined(a)&&(d.isDefined(n[a])||(m.push(a),n[a]=[]),n[a].push(b))});if(0<m.length){var p=h.rudder,q=!1;d.isObject(p)?d.isDefined(p.reverse)&&(q=g.convert_reverse(p.reverse)):q=g.convert_reverse(p);m=d.isDefined(p.fx)?m.sort(function(a,b){a=parseFloat(p.fx.call(B,n[a]));b=parseFloat(p.fx.call(B,n[b]));return(a<b?-1:1)*[1,-1][+!!q]}):m.sort(function(a,b){return C(a,b)*[1,-1][+!!q]});d.each(m,function(a,e){a=n[e];c<b.length-1?(a=g.order_by(a,b,c+1,f),d.each(a,function(a,
b){l.push(b)})):d.each(a,function(a,b){l.push(g.get_row_data(b,f))})})}else return g.order_by(a,b,c+1,f)}return l},get_row_data:function(a,b){var c={};d.each(b,function(b,e){b=e.field;d.isDefined(a[b])&&(c[""==e.alias?e.field:e.alias]=a[b])});return c}});k.fn=k.prototype={model:"1.0.1",constructor:k,extend:function(){return d.extend.apply(this,arguments)},init:function(a){this.clear();this.table(a);y=(new Date).getTime();return this},debug:function(a){x=a;return this}};k.fn.extend({clear:function(){this.bindings=
{where:new r("&&"),fields:[],limit:[],order_by:[]};return this},table:function(a,b){p=a;b=d.trim(b);d.isString(b)&&""!=b&&m.split_name(b," ");return this},fields:function(a){var b=this;d.isString(a)||d.isObject(a)?b.bindings.fields.push(a):d.isArray(a)&&d.each(a,function(a,d){b.fields(d)});return this},join:function(a,b,c,d){d=m.convert_join_type(d);c=m.split_name(c,".");var e=c[0];c=c[1];var f=function(a,b,c){var d={},f;for(f in a)d[f]=a[f];for(var g in b)d[e+"."+g]=1==c?b[g]:null;return d};p="right"==
d||"inner"==d&&p.length>b.length?m.join(b,c,p,a,d,f):m.join(p,a,b,c,d,f);w("end of join,data.length:",p.length);return this},order_by:function(a,b){var c=this;d.isArray(a)?d.each(a,function(a,d){c.order_by(d,b)}):d.isObject(a)?d.each(a,function(a,b){c.order_by(a,b)}):d.isString(a)&&c.bindings.order_by.push({field:a,rudder:b});return this},where:function(a,b,c,d){this.bindings.where.where(a,b,c,d);return this},where_in:function(a,b,c){d.isString(a)&&this.where(function(){if(d.isArray(b))for(var c in b)this.where(a,
t[0],b[c],v[0])},c);return this},where_not_in:function(a,b,c){d.isString(a)&&this.where(function(){if(d.isArray(b))for(var c in b)this.where(a,"!=",b[c],t[0])},c);return this},where_between:function(a,b,c){d.isArray(b)&&1<b.length&&this.where(function(){this.where(a,">",Math.min(b[0],b[1]));this.where(a,"<",Math.max(b[0],b[1]))},c);return this},where_like:function(a,b,c){this.where(a,b,"like",c);return this},limit:function(a,b){1==arguments.length?this.bindings.limit=[0,Math.max(0,a)]:1<arguments.length&&
(this.bindings.limit=[Math.max(0,a),Math.max(0,a+b)]);return this},get:function(){var a=this,b=[],c=m.convert_columns(p[0],a.bindings.fields);1>a.bindings.order_by.length?d.each(p,function(d,e){a.bindings.where.isMatch(e)&&b.push(m.get_row_data(e,c))}):b=m.order_by(p,a.bindings.order_by,0,c,function(b,c){return a.bindings.where.isMatch(b)&&!0});0<a.bindings.limit.length&&(b=b.slice(a.bindings.limit[0],Math.min(a.bindings.limit[1],b.length)));w("List--",b);w("SQL--",this.toSql());a.clear();return b},
find:function(a){return this.where(a).get()[0]},fetch:function(a){var b=this.get();return d.isFunction(a)?(d.each(b,a),this):b},select:function(a,b){return this.fields(a).where(b).get()},count:function(){return this.get().length},toSql:function(){return this.bindings.where.queryString(p[0])}});k.fn.init.prototype=k.fn;k.fn.size=function(){return this.length};"function"===typeof define&&define.amd&&define("model",[],function(){return k});var I=h.Model,J=h.M;k.noConflict=function(a){h.M===k&&(h.M=J);
a&&h.Model===k&&(h.Model=I);return k};q||(h.Model=h.M=k);return k});
