(function(k,t){"object"===typeof module&&"object"===typeof module.exports?module.exports=k.document?t(k,!0):function(k){if(!k.document)throw Error("Model requires a window with a document");return t(k)}:t(k)})("undefined"!==typeof window?window:this,function(k,t){function C(a,b){if("string"==typeof a&&"string"==typeof b)return a.localeCompare(b);if("number"==typeof a&&"string"==typeof b)return-1;if("string"==typeof a&&"number"==typeof b)return 1;if("number"==typeof a&&"number"==typeof b){if(a>b)return 1;
if(a==b)return 0;if(a<b)return-1}return 0}function u(a,b,c,d){this.field=a;this.value=b;this.operator=c;this.boolean=d}function p(a){this.boolean=a;var b=[];this.getConditionArr=function(){return b};this.addCondition=function(a){a instanceof u||a instanceof p?b.push(a):d.isString(a)&&b.push(eval(a));return this};this.where=function(a,f,g,e){e=l.convert_boolean(e);g=l.convert_operator(g);if(d.isObject(a))for(var c in a)this.where(c,a[c],g,f);else if(d.isArray(a))for(var q in a)d.isDefined(a[q].field)&&
d.isDefined(a[q].value)&&this.where(a[q].field,a[q].value,a[q].operator,a[q]["boolean"]);else d.isString(a)&&0<String(a).length?b.push(new u(a,f,g,e)):d.isFunction(a)&&(f=new p(l.convert_boolean(f)),b.push(f),a.call(f));return this};this.queryString=function(a){var b="";d.each(this.getConditionArr(),function(c,e){var f=[];0<parseInt(c)&&(b+=d.inArray(e["boolean"],v,0)?" OR ":" AND ");e instanceof p?b+="("+e.queryString(a)+")":e instanceof u&&(c=e.field,d.isDefined(a[c])?(f.push(d.isNumber(a[c])?"{"+
c+"}":"'{"+c+"}'"),f.push(e.operator),f.push(d.isNumber(e.value)?e.value:"'"+("like"==e.operator?"%"+String(e.value)+"%":String(e.value))+"'")):f.push("false"));b+=f.join(" ")});return b};this.isLike=function(a,b){var c=!1;d.each(b,function(b,d){if(""!==d&&-1<String(a).indexOf(d))return c=!0,!1});return c};this.isMatch=function(a){var b=this,c=!1;d.each(this.getConditionArr(),function(e,f){var g=!1;if(f instanceof p)g=f.isMatch(a);else if(f instanceof u){var h=f.field,n=f.value;if(d.isDefined(a[h]))switch(f.operator){case "=":case "==":case "===":g=
a[h]==n;break;case "<>":case "!=":case "!==":g=a[h]!=n;break;case "<":g=a[h]<n;break;case "<=":g=a[h]<=n;break;case ">":g=a[h]>n;break;case ">=":g=a[h]>=n;break;case ">>":g=a[h]>>n;break;case "<<":g=a[h]<<n;break;case "like":n=String(n).replace(D,E);g=n.split("%");g=b.isLike(a[h],g);break;default:g=!1}}else g=f;0==e&&(c=g);-1!=d.inArray(f["boolean"],v,0)?c=c||g:0<e&&(c=c&&g)});return c}}var x=!1,y=null,r=[],w="== === < > <= >= <> != << >> like".split(" "),z=["&&","||","|"],F={and:"&&",or:"||"},A=
["left","right","inner"],v=["||","|","or"],G=/^[\s\uFEFF\xA0]+|[\s\uFEFF\xA0]+$/g,D=/\\|'|\r|\n|\u2028|\u2029/g,m=function(a){return new m.fn.init(a)},H={"'":"'","\\":"\\","\r":"r","\n":"n","\u2028":"u2028","\u2029":"u2029"},E=function(a){return"\\"+H[a]},B={get data(){return r},each:function(){d.each.apply(this,arguments)},sum:function(a,b){var c=0;this.each(b,function(b,g){d.isDefined(g[a])&&(c+=parseFloat(g[a]))});return c}},I=function(){if(1==x){var a=["echo["+((new Date).getTime()-y)+"]:"],b;
for(b in arguments)a.push(arguments[b]);console.log.apply(this,a)}},d={inArray:function(a,b,c){var d;if(b){if([].indexOf)return Array.prototype.indexOf.call(b,a,c);d=b.length;for(c=c?0>c?Math.max(0,d+c):c:0;c<d;c++)if(c in b&&b[c]===a)return c}return-1},typeToString:function(a){return Object.prototype.toString.call(a)},trim:function(a){return null==a?"":(a+"").replace(G,"")},isWindow:function(a){return null!=a&&a==a.window},isEmptyObject:function(a){var b=0,c;for(c in a)if(b++,0<b)return!1;return!0},
isPlainObject:function(a){var b;if(!a||"object"!==typeof a||a.nodeType||this.isWindow(a))return!1;var c=Object.prototype.hasOwnProperty;try{if(a.constructor&&!c.call(a,"constructor")&&!c.call(a.constructor.prototype,"isPrototypeOf"))return!1}catch(f){return!1}for(b in a);return void 0===b||c.call(a,b)},isArray:function(a){return"[object Array]"==this.typeToString(a)},isDefined:function(a){return"undefined"!=typeof a},extend:function(){var a,b,c,f,g,e=arguments[0]||{},h=1,q=arguments.length,l=!1;"boolean"===
typeof e&&(l=e,e=arguments[h]||{},h++);"object"===typeof e||d.isFunction(e)||(e={});h===q&&(e=this,h--);for(;h<q;h++)if(null!=(g=arguments[h]))for(f in g)a=e[f],c=g[f],e!==c&&(l&&c&&(d.isPlainObject(c)||(b=d.isArray(c)))?(b?(b=!1,a=a&&d.isArray(a)?a:[]):a=a&&d.isPlainObject(a)?a:{},e[f]=d.extend(l,a,c)):void 0!==c&&(e[f]=c));return e},each:function(a,b){var c,f=0;if(d.isArray(a))for(c=a.length;f<c&&!1!==b.call(a[f],f,a[f]);f++);else for(f in a)if(!1===b.call(a[f],f,a[f]))break;return a},filter:function(a,
b){var c=d.isArray(a)?{}:[];d.each(a,function(a,g){d.isFunction()&&(c[a]=b.call(g,g,a))});return c}};d.each("Arguments Function String Number Date RegExp Error Object Boolean".split(" "),function(a,b){d["is"+b]=function(a){return d.typeToString(a)==="[object "+b+"]"}});var l={extend:function(){d.extend.apply(this,arguments)}};l.extend({split_name:function(a,b){b=b?b:" ";a=d.trim(a.replace(/\s+/g," "));b=a.split(b);a=b[0];return[a,1<b.length?b[1]:a]},convert_join_type:function(a){return-1!=d.inArray(String(a).toLocaleLowerCase(),
A,0)?a:A[2]},convert_reverse:function(a){return"desc"==String(a).toLocaleLowerCase()||1==a||1==a?1:0},convert_boolean:function(a){a=-1!=d.inArray(a,["and","or"],0)?F[a]:a;return d.isString(a)&&-1<d.inArray(a,z,0)?a:z[0]},convert_operator:function(a){return d.isString(a)&&-1<d.inArray(a,w,0)?a:w[0]},convert_columns:function(a,b){var c=[];b=0<b.length?b:["*"];var f=0,g;for(g in b){var e=b[g];if(d.isString(e))if(e=d.trim(e),/^\s*\*\s*$/gi.test(e)){f++;for(var h in a)c.push({field:h,alias:""})}else e=
e.replace(/^\s+(as)\s+$/i," as ").split(" as "),c.push({field:e[0],alias:e[1]?e[1]:""});else if(d.isObject(e))for(h in e)c.push({field:h,alias:d.isString(e[h])?e[h]:""})}return c},groups:function(a,b,c){var f={},g=[];d.each(a,function(a,h){d.isDefined(h[b])&&(a=h[b],d.isDefined(f[a])||(g.push(a),f[a]=[],d.isFunction(c)&&c.call(h,a)),f[a].push(h))});return f},join:function(a,b,c,f,g,e){var h=[],l=c[0],k=this.groups(c,f);d.each(a,function(a,c){a=c[b];d.isDefined(k[a])?d.each(k[a],function(a,b){d.isFunction(e)&&
h.push(d.extend({},e.apply(d,[c,b,!0])))}):-1!=d.inArray(g,["left","right"],0)&&d.isFunction(e)&&h.push(d.extend({},e.apply(d,[c,l,!1])))});return h},order_by:function(a,b,c,f,g){c=c?c:0;var e=this,h=[];if(0<b.length&&c<b.length){var l=b[c],k=[],n=e.groups(a,l.field,function(a){k.push(a)});if(0<k.length){var m=l.rudder,p=!1;d.isObject(m)?d.isDefined(m.reverse)&&(p=e.convert_reverse(m.reverse)):p=e.convert_reverse(m);k=d.isDefined(m.fx)?k.sort(function(a,b){a=parseFloat(m.fx.call(B,n[a]));b=parseFloat(m.fx.call(B,
n[b]));return(a<b?-1:1)*[1,-1][+!!p]}):k.sort(function(a,b){return C(a,b)*[1,-1][+!!p]});d.each(k,function(a,k){a=e.order_by(n[k],b,c+1,f,g);d.each(a,function(a,b){h.push(b)})})}else return e.order_by(a,b,c+1,f,g)}else d.each(a,function(a,b){if(e.is_match(b,f)){var c={};d.each(g,function(a,f){a=f.field;d.isDefined(b[a])&&(c[""==f.alias?f.field:f.alias]=b[a])});h.push(c)}});return h},get_sort:function(a,b){var c=!1;d.each(a,function(a,d){if(d.field==b)return c=d,!1});return c},is_match:function(a,
b){var c=!0,f=0;d.each(b,function(b,e){e instanceof p&&(c=0==f?e.isMatch(a):-1!=d.inArray(e["boolean"],v,0)?c||e.isMatch(a):c&&e.isMatch(a),f++)});return c},get_sql:function(a,b){var c=[];d.each(b,function(b,g){g instanceof p&&(0<c.length&&c.push(d.inArray(g.boolean,v,0)?" OR ":" AND "),c.push(g.queryString(a)))});return c.join(" ")}});m.fn=m.prototype={model:"1.0.1",constructor:m,extend:function(){return d.extend.apply(this,arguments)},init:function(a){this.clear();this.table(a);y=(new Date).getTime();
return this},debug:function(a){x=a;return this}};m.fn.extend({clear:function(){this.bindings={where:[],wheres:[],fields:[],limit:[],order_by:[]};return this},table:function(a,b){r=a;b=d.trim(b);d.isString(b)&&""!=b&&l.split_name(b," ");return this},fields:function(a){var b=this;d.isString(a)||d.isObject(a)?b.bindings.fields.push(a):d.isArray(a)&&d.each(a,function(a,d){b.fields(d)});return this},join:function(a,b,c,d){d=l.convert_join_type(d);c=l.split_name(c,".");var f=c[0];c=c[1];var e=function(a,
b,c){var d={},e;for(e in a)d[e]=a[e];for(var g in b)d[f+"."+g]=1==c?b[g]:null;return d};r="right"==d?l.join(b,c,r,a,d,e):l.join(r,a,b,c,d,e);I("__data.length",r.length);return this},order_by:function(a,b){var c=this;d.isArray(a)?d.each(a,function(a,d){c.order_by(d,b)}):d.isObject(a)?d.each(a,function(a,b){c.order_by(a,b)}):d.isString(a)&&c.bindings.order_by.push({field:a,rudder:b});return this},where:function(a,b,c,f){f=l.convert_boolean(f);c=l.convert_operator(c);if(d.isObject(a))for(var g in a)this.where(g,
a[g],c,l.convert_boolean(b));else if(d.isArray(a))for(var e in a)d.isDefined(a[e].field)&&d.isDefined(a[e].value)&&this.where(a[e].field,a[e].value,a[e].operator,a[e]["boolean"]);else d.isString(a)&&0<String(a).length?this.bindings.where.push((new p(f)).where(a,b,c,f)):d.isFunction(a)&&(c=new p(l.convert_boolean(b)),b=new p(l.convert_boolean(b)),c.addCondition(b),this.bindings.where.push(c),a.call(b));return this},where_in:function(a,b,c){d.isString(a)&&this.where(function(){if(d.isArray(b))for(var c in b)this.where(a,
b[c],w[0],"||")},c);return this},where_not_in:function(a,b,c){d.isString(a)&&this.where(function(){if(d.isArray(b))for(var c in b)this.where(a,b[c],"!=")},c);return this},where_between:function(a,b){d.isArray(b)&&1<b.length&&this.where(function(){this.where(a,Math.min(b[0],b[1]),">");this.where(a,Math.max(b[0],b[1]),"<")});return this},where_like:function(a,b,c){this.where(a,b,"like",c);return this},limit:function(a,b){1==arguments.length?this.bindings.limit=[0,Math.max(0,a)]:1<arguments.length&&
(this.bindings.limit=[Math.max(0,a),Math.max(0,a+b)]);return this},get:function(){var a=l.order_by(r,this.bindings.order_by,0,this.bindings.where);0<this.bindings.limit.length&&(a=a.slice(this.bindings.limit[0],this.bindings.limit[1]));console.log(a);return a},find:function(a){return this.where(a).get()[0]},fetch:function(a){var b=this.get();return d.isFunction(a)?(d.each(b,a),this):b},select:function(a,b){return this.fields(a).where(b).get()},count:function(){return this.get().length},toSql:function(a){var b=
l.get_sql(r[0],this.bindings.where);return 1==a?(console.log(b),this):b}});m.fn.init.prototype=m.fn;m.fn.size=function(){return this.length};"function"===typeof define&&define.amd&&define("model",[],function(){return m});var J=k.Model,K=k.M;m.noConflict=function(a){k.M===m&&(k.M=K);a&&k.Model===m&&(k.Model=J);return m};t||(k.Model=k.M=m);return m});
